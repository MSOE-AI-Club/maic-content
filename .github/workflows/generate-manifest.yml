name: Generate manifest.json

on:
  push:
    branches: '*'

jobs:
  generate-manifest:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Generate manifest.json
      run: |
        echo "Generating manifest..."
        node <<'EOF'
        const fs = require('fs');
        const path = require('path');

        function walkDir(dir, baseDir = dir) {
          const files = fs.readdirSync(dir, { withFileTypes: true });
          return files.flatMap(file => {
            const fullPath = path.join(dir, file.name);
            if (file.isDirectory()) {
              return walkDir(fullPath, baseDir);
            } else {
              return [path.relative(baseDir, fullPath).replace(/\\/g, '/')];
            }
          });
        }

        const fileList = walkDir('.');
        const manifest = { generated_at: new Date().toISOString(), files: fileList };
        fs.writeFileSync('manifest.json', JSON.stringify(manifest, null, 2));
        EOF

    - name: Commit and push manifest.json
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git add manifest.json
        git commit -m "chore: auto-generate manifest.json" || echo "No changes to commit"
        git push
